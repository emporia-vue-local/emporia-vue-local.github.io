---
sidebar_position: 3
---
import Link from '@docusaurus/Link';

# Flashing

## Verifying the connection

Open a console window where `esptool` is available. Test it using `esptool version`.

## Preparation

Follow the instructions for your specific hardware:

<div style={{display: 'flex', gap: '1rem', flexWrap: 'wrap', justifyContent: 'center', marginTop: '20px'}}>
  <Link
    className="pagination-nav__link"
    to="./hardware-prep-v2">
    <div className="pagination-nav__sublabel">Continue to</div>
    <div className="pagination-nav__label">Hardware Prep for the Emporia Vue 2</div>
  </Link>
  <Link
    className="pagination-nav__link"
    to="./hardware-prep-v3">
    <div className="pagination-nav__sublabel">Continue to</div>
    <div className="pagination-nav__label">Hardware Prep for the Emporia Vue 3</div>
  </Link>
</div>


## Backing up factory software

:::warning

Successful completion of this step is _critical_ in case something goes wrong later. This file is necessary to restore the device to factory function.

:::

Run the following in the console: `esptool.py -b 921600 read_flash 0 0x800000 flash_contents.bin`.

If the above command fails, try again using `esptool.py -b 115200 read_flash 0 0x800000 flash_contents.bin`. 

:::info

**Apple Silicon (M1, M2, etc)**

If you're using an Apple Silicon (M1, M2, etc) CPU and it stops working after a certain percentage every time, try using a different machine.

:::

## Setting up basic configuration

Create a new device in ESPHome, either by manually creating a new yaml file for your configuraiton, or by using the new device wizard in the ESPHome UI.

Set it up like this to start out with. We will load the configuration for your specific setup later, over WiFi, once the system is installed in the panel:

```yaml
esphome:
  name: emporiavue2
  friendly_name: vue2

external_components:
  - source: github://emporia-vue-local/esphome@dev
    components:
      - emporia_vue

esp32:
  board: esp32dev
  framework:
    type: esp-idf
    version: recommended

# Enable Home Assistant API
api:
  encryption:
    # Encryption key is generated by the new device wizard.
    key: "<generated_key_from_new_device_wizard>"

ota:
  # Create a secure password for pushing OTA updates.
  password: "<secure_password>"

logger:
  logs:
    # by default, every reading will be printed to the UART, which is very slow
    # This will disable printing the readings but keep other helpful messages
    sensor: INFO

wifi:
  # Wifi credentials are stored securely by new device wizard.
  ssid: !secret wifi_ssid
  password: !secret wifi_password
```

## Flashing ESPHome

### Command line

Run `esphome run <yourfilename>.yaml`, replacing `<yourfilename>.yaml` with the basic config you've set up above.

### ESPHome dashboard

If you're using the ESPHome dashboard, just click the install button and select "Plug into this computer" or "Plug into the computer running ESPHome Device Builder", as needed for your situation.

### Expected error messages

Once installed, you might see a bunch of errors like `Failed to read from sensor due to I2C error 3`, but that's fine, and they'll go away when it is installed into the wall.
